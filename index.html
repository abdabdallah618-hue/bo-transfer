<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Device & Zone Manager</title>
<style>
body {
    font-family: system-ui,Segoe UI,Roboto,"Noto Sans",Arial;
    direction: rtl;
    padding: 20px;
    background: #0f111a;
    color: #e0e0e0;
}
h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #00e0ff;
    text-shadow: 0 0 10px #00e0ff;
}
textarea, input[type="file"] {
    width: 100%;
    margin-bottom: 12px;
    background: #1f1f2b;
    border: 1px solid #333;
    border-radius: 8px;
    color: #e0e0e0;
    padding: 10px;
    font-size: 14px;
}
button {
    padding: 10px 20px;
    margin: 5px 2px;
    cursor: pointer;
    transition: 0.3s;
    background: linear-gradient(135deg,#4e9af1,#1e90ff);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
button:hover {
    background: linear-gradient(135deg,#1e90ff,#4e9af1);
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    background: #1f1f2b;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
}
th, td {
    border: 1px solid #333;
    padding: 10px;
    text-align: center;
    font-size: 14px;
}
th {
    background: #2c2c3a;
    color: #00e0ff;
}
input[type="text"].zone-new {
    width: 100%;
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #555;
    background: #2c2c3a;
    color: #e0e0e0;
}
.separator {
    height: 2px;
    background: #333;
    margin: 40px 0;
}
</style>
</head>
<body>

<h2>Device & Zone Manager | النظام المتكامل</h2>

<!-- النظام القديم -->
<textarea id="raw" placeholder="ألصق البيانات الثلاثة أعمدة هنا"></textarea>
<div class="buttons-wrapper">
    <button id="togglePreviewOld">حول الجدول القديم</button>
    <button id="exportExcelOld">تحميل Excel القديم</button>
    <button id="changeCreatedByOld">تغيير Created by</button>
</div>
<div id="tblWrapOld" style="display:none;"></div>

<div class="separator"></div>

<!-- النظام الجديد -->
<input type="file" id="excelFile" accept=".xlsx,.xls">
<div class="buttons-wrapper">
    <button id="loadExcel">تحميل بيانات Excel</button>
</div>

<div id="zoneMapping"></div>
<div class="buttons-wrapper">
    <button id="applyZones">تطبيق الـ Zones الجديدة</button>
</div>

<div class="separator"></div>

<div class="buttons-wrapper">
    <button id="togglePreviewNew">معاينة الجدول النهائي</button>
    <button id="changeCreatedByNew">تغيير Created by</button>
    <button id="exportExcelNew">تصدير Excel النهائي</button>
</div>
<div id="tblWrapNew" style="display:none;"></div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>

// =================== النظام القديم ===================
let previewVisibleOld = false;
let createdByOld = 'غير مخصص';

function cleanZeros(token){
    return token ? token.replace(/([A-Za-z\u0621-\u064A]+)0+(\d+)/g, '$1$2') : token;
}

function parseLinesOld(text, createdBy){
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
        var parts = line.split(/\t|\s+/);
        if(parts.length < 3) return null;
        var contract = parts[0];
        var zone = parts[1];
        var fdt = cleanZeros(parts[2]);
        return [contract, zone, fdt, createdBy];
    }).filter(Boolean);
}

function buildTableOld(rows){
    if(rows.length === 0){
        document.getElementById('tblWrapOld').innerHTML = '<p>لا توجد بيانات.</p>';
        return;
    }
    let html = '<table id="mainTableOld"><thead><tr>'+
               '<th>Contract</th><th>Zone</th><th>FDT</th><th>Created by</th>'+
               '</tr></thead><tbody>';
    rows.forEach(r=>{
        html += `<tr>
                    <td>${r[0]}</td>
                    <td>${r[1]}</td>
                    <td>${r[2]}</td>
                    <td><input type="text" value="${r[3]}"></td>
                 </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('tblWrapOld').innerHTML = html;
}

document.getElementById('togglePreviewOld').addEventListener('click', function(){
    const text = document.getElementById('raw').value.trim();
    if(!previewVisibleOld){
        if(!text){
            alert('ألصق البيانات أولاً');
            return;
        }
        if(!createdByOld){
            const inputName = prompt('اكتب اسم Created by:', '');
            createdByOld = inputName === null || inputName.trim() === '' ? 'غير مخصص' : inputName;
        }
        const rows = parseLinesOld(text, createdByOld);
        buildTableOld(rows);
        document.getElementById('tblWrapOld').style.display = 'block';
        this.textContent = 'إخفاء المعاينة';
        previewVisibleOld = true;
    } else {
        document.getElementById('tblWrapOld').style.display = 'none';
        this.textContent = 'حول الجدول القديم';
        previewVisibleOld = false;
    }
});

document.getElementById('changeCreatedByOld').addEventListener('click', function(){
    const table = document.getElementById('mainTableOld');
    if(!table){ alert('لا توجد بيانات لتغيير Created by!'); return; }
    const newName = prompt('اكتب الاسم الجديد لـ Created by:', '');
    if(newName === null) return;
    const finalName = newName.trim() === '' ? 'غير مخصص' : newName.trim();
    table.querySelectorAll('tbody tr').forEach(tr=>{
        const input = tr.querySelector('td:nth-child(4) input');
        if(input) input.value = finalName;
    });
    createdByOld = finalName;
});

document.getElementById('exportExcelOld').addEventListener('click', function(){
    const table = document.getElementById('mainTableOld');
    if(!table){ alert('لا توجد بيانات للتحميل!'); return; }
    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
        const tds = tr.querySelectorAll('td');
        return [tds[0].textContent, tds[1].textContent, tds[2].textContent, tds[3].querySelector('input').value];
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([["Contract","Zone","FDT","Created by"], ...rows]);
    XLSX.utils.book_append_sheet(wb, ws, "Table");
    XLSX.writeFile(wb, "OldData.xlsx");
});

// =================== النظام الجديد ===================
let rawDataNew = [];
let previewVisibleNew = false;
let createdByNew = 'غير مخصص';

// مصفوفة Zones مسبقة
const predefinedZones = {
  "FMS0464": "FMS0464-3",
  "FMS0465": "FMS0465-3",
  "FMS0466": "FMS0466-2",
  "FMS0467": "FMS0467-2",
  "FMS0468": "FMS0468-2",
  "FMS0469": "FMS0469-3",
  "FMS0470": "FMS0470-2"
};

// رفع Excel واستخراج Device Username و Zone
document.getElementById('loadExcel').addEventListener('click', () => {
    const fileInput = document.getElementById('excelFile');
    if(fileInput.files.length === 0){ alert('اختر ملف Excel أولاً!'); return; }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});

        const headers = jsonData[0].map(h=>h.toString().trim().toLowerCase());
        const deviceIndex = headers.findIndex(h => h === 'device username');
        const zoneIndex = headers.findIndex(h => h === 'zone');

        if(deviceIndex === -1 || zoneIndex === -1){ alert('تأكد أن الملف يحتوي على Device Username و Zone'); return; }

        rawDataNew = jsonData.slice(1).map(row => ({device: row[deviceIndex]||'', zone: row[zoneIndex]||''}));
        buildZoneMapping(rawDataNew);
    };
    reader.readAsArrayBuffer(file);
});

// إنشاء جدول تعديل Zone مع القيم المسبقة
function buildZoneMapping(data){
    const uniqueZones = [...new Set(data.map(d => d.zone))];
    let html = '<table><thead><tr><th>Zone القديم</th><th>Zone الجديد</th></tr></thead><tbody>';
    uniqueZones.forEach(z=>{
        const newZone = predefinedZones[z] || ""; // يتم ملؤه مسبقاً
        html += `<tr>
                    <td>${z}</td>
                    <td><input class="zone-new" type="text" value="${newZone}"></td>
                 </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('zoneMapping').innerHTML = html;
}

// تطبيق التغييرات على جميع Device Username
document.getElementById('applyZones').addEventListener('click', ()=>{
    const table = document.querySelector('#zoneMapping table');
    if(!table){ alert('لا توجد بيانات Zones لتطبيقها!'); return; }
    const rows = table.querySelectorAll('tbody tr');
    const zoneMap = {};
    rows.forEach(tr=>{
        const oldZone = tr.cells[0].textContent;
        const newZone = tr.querySelector('input').value.trim();
        if(newZone) zoneMap[oldZone] = newZone;
    });
    rawDataNew = rawDataNew.map(r=>({...r, zone: zoneMap[r.zone]||r.zone}));
    alert('تم تطبيق الـ Zones الجديدة بنجاح!');
});

// معاينة الجدول النهائي
document.getElementById('togglePreviewNew').addEventListener('click', function(){
    if(!previewVisibleNew){
        if(rawDataNew.length === 0){ alert('لا توجد بيانات لعرضها!'); return; }
        if(!createdByNew){
            const inputName = prompt('اكتب اسم Created by:', '');
            createdByNew = inputName===null||inputName.trim()===''?'غير مخصص':inputName.trim();
        }
        buildPreviewTableNew();
        document.getElementById('tblWrapNew').style.display='block';
        this.textContent='إخفاء المعاينة';
        previewVisibleNew=true;
    } else {
        document.getElementById('tblWrapNew').style.display='none';
        this.textContent='معاينة الجدول النهائي';
        previewVisibleNew=false;
    }
});

// بناء جدول Preview الجديد مع FDT من Zone الجديد
function buildPreviewTableNew(){
    const htmlRows = rawDataNew.map(r => {
        const fdtValue = cleanZeros(r.zone); // FDT يعتمد على Zone الجديد
        return `<tr>
            <td>${r.device}</td>
            <td>${r.zone}</td>
            <td><input type="text" value="${fdtValue}"></td>
            <td><input type="text" value="${createdByNew}"></td>
        </tr>`;
    }).join('');
    const html = `<table id="mainTableNew"><thead>
        <tr><th>Contract</th><th>Zone</th><th>FDT</th><th>Created by</th></tr>
    </thead><tbody>${htmlRows}</tbody></table>`;
    document.getElementById('tblWrapNew').innerHTML=html;
}

// تغيير Created by
document.getElementById('changeCreatedByNew').addEventListener('click', ()=>{
    const table=document.getElementById('mainTableNew');
    if(!table){ alert('لا توجد بيانات لتغيير Created by!'); return; }
    const newName = prompt('اكتب الاسم الجديد لـ Created by:', '');
    if(newName===null) return;
    const finalName = newName.trim()===''?'غير مخصص':newName.trim();
    table.querySelectorAll('tbody tr').forEach(tr=>{
        const input = tr.querySelector('td:nth-child(4) input');
        if(input) input.value = finalName;
    });
    createdByNew = finalName;
});

// تصدير Excel النهائي
document.getElementById('exportExcelNew').addEventListener('click', ()=>{
    const table = document.getElementById('mainTableNew');
    if(!table){ alert('لا توجد بيانات لتصديرها!'); return; }
    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return [
            tds[0].textContent,
            tds[1].textContent,
            tds[2].querySelector('input').value,
            tds[3].querySelector('input').value
        ];
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([["Contract","Zone","FDT","Created by"], ...rows]);
    XLSX.utils.book_append_sheet(wb, ws, "Table");
    XLSX.writeFile(wb, "FinalData.xlsx");
});
</script>

</body>
</html>
